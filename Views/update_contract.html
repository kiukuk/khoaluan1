<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·ªânh s·ª≠a h·ª£p ƒë·ªìng</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Averta+Std+CY:wght@400;600;700&display=swap" />
    <link rel="stylesheet" href="../Public/css/hopdong.css" />
    <link rel="stylesheet" href="../Public/css/add-contract.css" />
</head>

<body>
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/Spe1ONBMGo.png" alt="Logo"
                class="logo" />
            <div class="menu-right">
                <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/gFm7CJOc6m.png" alt="Support"
                    class="icon" />
                <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/OaQkGHAx1s.png" alt="Flag"
                    class="icon flag" />
                <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/xq6CkhC2ow.png"
                    alt="Notifications" class="icon" />
                <div class="user">
                    <span id="userFullName">ƒêang t·∫£i...</span>
                    <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/xkBp40jWqg.png" alt="Avatar"
                        class="avatar" />
                </div>
            </div>
        </header>

        <!-- Menu -->
        <!-- Menu -->
        <nav class="cms-menu">
            <a href="#" onclick="navigateTo('tong quan/tongquan.html')" class="menu-link">
                <div class="menu-item">
                    <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/RDy2m7oGdJ.png"
                        alt="Dashboard" class="menu-icon" />
                    <span>T·ªïng quan</span>
                </div>
            </a>
            <a href="#" onclick="navigateTo('taikhoan/taikhoan.html')" class="menu-link">
                <div class="menu-item">
                    <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/Kb6jp7Zyvp.png"
                        alt="Account" class="menu-icon" />
                    <span>T√†i kho·∫£n</span>
                </div>
            </a>
            <a href="#" onclick="navigateTo('hopdong/hopdong.html')" class="menu-link">
                <div class="menu-item">
                    <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/P3fdYxESjy.png"
                        alt="Contract" class="menu-icon" />
                    <span>H·ª£p ƒë·ªìng</span>
                </div>
            </a>
            <a href="#" onclick="navigateTo('khachhang/khachhang.html')" class="menu-link">
                <div class="menu-item">
                    <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/CSD90LxuhK.png"
                        alt="Customer" class="menu-icon" />
                    <span>Kh√°ch h√†ng</span>
                </div>
            </a>
            <a href="#" onclick="navigateTo('baocao/baocao.html')" class="menu-link">
                <div class="menu-item">
                    <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/beO9yV4pmy.png" alt="Report"
                        class="menu-icon" />
                    <span>B√°o c√°o</span>
                </div>
            </a>
            <a href="#" onclick="navigateTo('dulieu/dulieu.html')" class="menu-link">
                <div class="menu-item">
                    <img src="https://codia-f2c.s3.us-west-1.amazonaws.com/image/2025-04-11/kL7HC5Fh6x.png" alt="Data"
                        class="menu-icon" />
                    <span>D·ªØ li·ªáu</span>
                </div>
            </a>
        </nav>

        <form id="updateContractForm">
            <!-- Add Contract Content -->
            <div class="add-contract-container">
                <div class="header-row">
                    <span style="font-size: 16px; color: #141414;">
                        <a href="hopdong.html" style="color: #007aff; text-decoration: none;">H·ª£p ƒë·ªìng |</a> Ch·ªânh s·ª≠a
                        h·ª£p
                        ƒë·ªìng
                    </span>
                    <div class="action-buttons">
                        <button id="save-button" type="button" class="btn-edit">L∆∞u</button>
                        <div style="margin-right: 10px;"></div>
                        <button id="cancel-button" class="btn-cancel">H·ªßy b·ªè</button>
                    </div>
                </div>

                <div class="scrollable-content">
                    <div class="add-contract-content">
                        <!-- Th√¥ng tin h·ª£p ƒë·ªìng -->
                        <div class="info-section contract-info">
                            <h3>Th√¥ng tin h·ª£p ƒë·ªìng</h3>


                            <div class="info-columns">
                                <!-- C·ªôt 1 -->
                                <div class="info-column">
                                    <div class="form-group">
                                        <label class="required">M√£ kh√°ch h√†ng</label>
                                        <input type="text" id="customer-id" disabled />
                                    </div>
                                    <div class="form-group">
                                        <label class="required">M√£ H·ª£p ƒë·ªìng</label>
                                        <input type="text" id="contract-id" disabled />
                                    </div>
                                    <div class="form-group">
                                        <label class="required">T·ª´ ng√†y</label>
                                        <input type="date" id="start-date" />
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Gi√° tr·ªã h·ª£p ƒë·ªìng</label>
                                        <input type="text" id="contract-value" placeholder="0"
                                            oninput="updateSummary()" />
                                    </div>
                                </div>
                                <!-- C·ªôt 2 -->
                                <div class="info-column">
                                    <div class="form-group">
                                        <label class="required">T√™n kh√°ch h√†ng</label>
                                        <input type="text" id="customer-name" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng" />
                                    </div>
                                    <div class="form-group">
                                        <label class="required">M√£ s·ªë thu·∫ø</label>
                                        <input type="text" id="tax-code" placeholder="Nh·∫≠p m√£ s·ªë thu·∫ø" />
                                    </div>
                                    <div class="form-group">
                                        <label class="required">ƒê·∫øn ng√†y</label>
                                        <input type="date" id="end-date" />
                                    </div>
                                    <div class="form-group">
                                        <label>Nh√¢n vi√™n ph·ª• tr√°ch:
                                            <select id="staff-in-charge" required>
                                                <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                                            </select>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>T√†i li·ªáu li√™n quan</label>
                                <div class="drop-area" id="drop-area">
                                    <input type="file" id="related-docs" multiple accept=".doc,.docx,.pdf,.xls,.xlsx"
                                        style="display: none;" />
                                    <p class="drop-text">K√©o th·∫£ ho·∫∑c t·∫£i t·ªáp l√™n t·∫°i ƒë√¢y</p>
                                    <div class="file-list" id="file-list"></div>
                                </div>
                                <div class="file-note">Lo·∫°i ƒë·ªãnh d·∫°ng cho ph√©p: doc, pdf, excel. K√≠ch th∆∞·ªõc t·ªëi ƒëa: 5MB.
                                </div>
                            </div>
                        </div>

                        <!-- Th√¥ng tin th√™m -->
                        <div class="info-section additional-info">
                            <h3>Th√¥ng tin th√™m</h3>
                            <div class="additional-info-container">
                                <div class="additional-info-content">
                                    <div class="form-group">
                                        <label>Ng√†y k√Ω h·ª£p ƒë·ªìng</label>
                                        <input type="date" id="sign-date" />
                                    </div>
                                    <div class="form-group">
                                        <label>Ngu·ªìn ƒë·∫øn</label>
                                        <select id="source">

                                            <option value="Facebook">Facebook</option>
                                            <option value="Facebook">Instagram</option>
                                            <option value="Facebook">Website</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Khu v·ª±c</label>
                                        <select id="region">
                                            <option value="">ƒê√† N·∫µng</option>
                                            <option value="H√† N·ªôi">H√† N·ªôi</option>
                                            <option value="H√† N·ªôi">TP.H·ªì Ch√≠ Minh</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Tr·∫°ng th√°i</label>
                                        <select id="status">
                                            <option value="">Ch∆∞a g·ª≠i</option>

                                            <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
                                            <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
                                            <option value="Qu√° h·∫°n">Qu√° h·∫°n</option>
                                            <option value="ƒê√£ thanh to√°n m·ªôt ph·∫ßn">ƒê√£ thanh to√°n m·ªôt ph·∫ßn</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>T√™n c√¥ng ty (n·∫øu c√≥)</label>
                                        <input type="text" id="company-name" placeholder="Nh·∫≠p t√™n c√¥ng ty" />
                                    </div>
                                    <div class="form-group">
                                        <label class="required">T√™n s·∫£n ph·∫©m/d·ªãch v·ª•/gi·∫£i ph√°p</label>
                                        <input type="text" id="product-service"
                                            placeholder="Ph·∫ßn m·ªÅm qu·∫£n l√Ω ngu·ªìn s√°ch" />
                                    </div>
                                    <div class="form-group">
                                        <label>Ghi ch√∫</label>
                                        <input type="text" id="note" placeholder="Nh·∫≠p ghi ch√∫" />
                                    </div>
                                </div>
                                <div class="additional-info-empty"></div>
                            </div>
                        </div>
                    </div>

                    <!-- M√¥ t·∫£ chi ti·∫øt -->
                    <div class="info-section description-section">
                        <div class="description-header" onclick="toggleDescription()">
                            <h3>M√¥ t·∫£ chi ti·∫øt</h3>
                            <span class="dropdown-icon">‚ñº</span>
                        </div>
                        <div id="description-content" class="description-content" style="display: none;">
                            <div class="editor-toolbar">
                                <select onchange="formatText('formatBlock', this.value); this.value=''">
                                    <option value="">Format</option>
                                    <option value="p">Paragraph</option>
                                    <option value="h1">Heading 1</option>
                                    <option value="h2">Heading 2</option>
                                    <option value="h3">Heading 3</option>
                                </select>
                                <button onclick="formatText('bold')"><b>B</b></button>
                                <button onclick="formatText('italic')"><i>I</i></button>
                                <button onclick="formatText('underline')"><u>U</u></button>
                                <button onclick="formatText('justifyLeft')">üñáÔ∏è</button>
                                <button onclick="formatText('justifyCenter')">üñáÔ∏è</button>
                                <button onclick="formatText('justifyRight')">üñáÔ∏è</button>
                                <button onclick="formatText('insertUnorderedList')">‚Ä¢</button>
                                <button onclick="formatText('insertOrderedList')">1.</button>
                            </div>
                            <div id="editor" class="editor-content" contenteditable="true">
                                <p class="editor-placeholder" style="color: #666; opacity: 0.6;">Nh·∫≠p m√¥ t·∫£ chi ti·∫øt</p>
                            </div>
                        </div>
                    </div>

                    <!-- Thanh to√°n v√† Th√¥ng tin -->
                    <div class="tables-section">
                        <!-- B·∫£ng Thanh to√°n (B√™n tr√°i) -->
                        <div class="info-section payment-table">
                            <div class="table-wrapper">
                                <table id="payment-table">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>Ng√†y thanh to√°n</th>
                                            <th>T·ªïng ti·ªÅn</th>
                                        </tr>
                                    </thead>
                                    <tbody id="payment-table-body">
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td><a href="#" class="add-link" onclick="addPaymentRow(); return false;">+
                                                    Th√™m</a></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- B·∫£ng Th√¥ng tin (B√™n ph·∫£i) -->
                        <div class="info-section summary-table">
                            <h3>Th√¥ng tin</h3>
                            <div class="summary-content">
                                <p><strong>T·ªïng gi√° tr·ªã h·ª£p ƒë·ªìng:</strong> <span id="total-value">0</span></p>
                                <p><strong>ƒê√£ thanh to√°n:</strong> <span id="paid-value">0</span></p>
                                <p><strong>C√≤n l·∫°i:</strong> <span id="remaining-value">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </form>
    <!-- JavaScript -->
    <script>

        const queryParams = new URLSearchParams(window.location.search);
        const userId = queryParams.get("user_id");
        const roleId = queryParams.get("role_id"); // ‚¨ÖÔ∏è D√≤ng b·ªã thi·∫øu
        // L·∫•y user_id v√† role_id t·ª´ URL hi·ªán t·∫°i
        const urlParams = new URLSearchParams(window.location.search);
        // H√†m chuy·ªÉn trang ƒë√∫ng th∆∞ m·ª•c
        function navigateTo(page) {
            if (userId && roleId) {
                window.location.href = `/asiaclient/admin/${page}?user_id=${userId}&role_id=${roleId}`;
            } else {
                alert("Thi·∫øu user_id ho·∫∑c role_id. Kh√¥ng th·ªÉ chuy·ªÉn trang!");
            }
        }
        if (userId) {
            fetch(`../taikhoan/get_user_by_id.php?user_id=${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.full_name) {
                        document.getElementById("userFullName").textContent = data.full_name;
                    } else {
                        document.getElementById("userFullName").textContent = "Ng∆∞·ªùi d√πng";
                    }
                })
                .catch(err => {
                    console.error("L·ªói khi t·∫£i t√™n ng∆∞·ªùi d√πng:", err);
                    document.getElementById("userFullName").textContent = "Kh√¥ng r√µ";
                });
        }
        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            loadStaff();
            const userId = params.get("user_id");
            const roleId = params.get("role_id");
            const contractCode = params.get("contract_code"); // <- B·ªï sung d√≤ng n√†y
            if (!contractCode || !userId || !roleId) {
                alert("Thi·∫øu th√¥ng tin c·∫ßn thi·∫øt!");
                return;
            }

            fetch(`get_contract_by_code.php?contract_code=${contractCode}&user_id=${userId}&role_id=${roleId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.contract) {
                        const c = data.contract;
                        document.getElementById("contract-id").value = c.contract_code || "";
                        document.getElementById("customer-id").value = c.customer_id || "";
                        document.getElementById("customer-name").value = c.customer_name || "";
                        document.getElementById("contract-value").value = c.value || 0;
                        document.getElementById("start-date").value = c.start_date || "";
                        document.getElementById("end-date").value = c.end_date || "";
                        document.getElementById("sign-date").value = c.signing_date || "";
                        document.getElementById("status").value = c.status || "";
                        document.getElementById("note").value = c.note || "";
                    } else {
                        alert("Kh√¥ng t√¨m th·∫•y h·ª£p ƒë·ªìng!");
                    }
                })


            document.getElementById("updateContractForm").addEventListener("submit", function (e) {
                e.preventDefault();
                const staffSelect = document.getElementById("staff-in-charge");
                const staff_id = staffSelect.value;
                const staff_in_charge_name = staffSelect.options[staffSelect.selectedIndex]?.textContent || "";
                const start = new Date(document.getElementById("start-date").value);
                const sign = new Date(document.getElementById("sign-date").value);
                if (sign <= start) {
                    alert("Ng√†y k√Ω h·ª£p ƒë·ªìng ph·∫£i l·ªõn h∆°n ng√†y b·∫Øt ƒë·∫ßu!");
                    return;
                }

                const data = {
                    contract_code: document.getElementById("contract-id").value,
                    customer_id: document.getElementById("customer-id").value,
                    customer_name: document.getElementById("customer-name").value,
                    value: parseFloat(document.getElementById("contract-value").value),
                    start_date: document.getElementById("start-date").value,
                    end_date: document.getElementById("end-date").value,
                    signing_date: document.getElementById("sign-date").value,
                    status: document.getElementById("status").value,
                    note: document.getElementById("note").value,
                    staff_id: staff_id,
                    staff_in_charge_name: staff_in_charge_name
                };
                fetch("update_contract.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                })
                    .then(res => res.json())
                    .then(res => {
                        if (res.success) {
                            alert("C·∫≠p nh·∫≠t h·ª£p ƒë·ªìng th√†nh c√¥ng!");

                            // L·∫•y l·∫°i user_id v√† role_id t·ª´ URL
                            const params = new URLSearchParams(window.location.search);
                            const user_id = params.get('user_id');
                            const role_id = params.get('role_id');

                            // Quay l·∫°i hopdong.html v√† gi·ªØ nguy√™n user_id, role_id
                            window.location.href = `hopdong.html?user_id=${user_id}&role_id=${role_id}`;
                        } else {
                            alert("L·ªói: " + res.message);
                        }
                    })

            });
        });
        document.getElementById("save-button").addEventListener("click", () => {
            document.getElementById("updateContractForm").requestSubmit();
        });
        document.getElementById('cancel-button').addEventListener('click', function () {
            window.history.back();
        });
        // H√†m load nh√¢n vi√™n ph·ª• tr√°ch
        function loadStaff(selectedStaffId = null) {
            const staffSelect = document.getElementById("staff-in-charge");

            if (roleId === "1") {
                fetch("../taikhoan/get_users.php")
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            data.users.forEach(user => {
                                const option = document.createElement("option");
                                option.value = user.user_id;
                                option.textContent = user.full_name;
                                if (selectedStaffId && user.user_id == selectedStaffId) {
                                    option.selected = true;
                                }
                                staffSelect.appendChild(option);
                            });
                        }
                    });
            } else {
                fetch(`../taikhoan/get_user_by_id.php?user_id=${userId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            const user = data.user;
                            const option = document.createElement("option");
                            option.value = user.user_id;
                            option.textContent = user.full_name;
                            option.selected = true;
                            staffSelect.appendChild(option);
                            staffSelect.disabled = true;
                        }
                    });
            }
        }
        document.getElementById("save-button").addEventListener("click", () => {
            document.getElementById("updateContractForm").requestSubmit();
        });

    </script>